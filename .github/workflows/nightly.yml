name: Nightly

on:
  workflow_dispatch:
    inputs:
      source-repo:
        description: "ORG/REPO"
        required: true
        type: string
      source-github-run-id:
        description: "Repo GitHub Run ID"
        required: true                    #TODO
        type: string
      source-artifact-name:
        description: "Run Artifact Name"
        required: true                    #TODO
        type: string
      rocm-version:
        required: true
        type: string
      ubuntu-version:
        required: true
        type: string
      rocm-build-num:
        required: false
        type: string
        default: "0"
      github-sha:
        required: false
        type: string
        default: ToT
      runner-label:
        required: false
        type: string
        default: "MI300"
    secrets:
      ROCM_JAX_DB_HOSTNAME:
        required: true
      ROCM_JAX_DB_USERNAME:
        required: true
      ROCM_JAX_DB_PASSWORD:
        required: true
      ROCM_JAX_DB_NAME:
        required: true

jobs:
  upload-to-db:
    runs-on: mysqldb
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
      - name: Download logs artifact from source run
        env:
          GH_TOKEN: ${{ secrets.SECRET_TOKEN }}
        run: |
          gh run download "${{ inputs.source-github-run-id }}" \
            -R "${{ inputs.source-repo }}" \
            -n "${{ inputs.source-artifact-name }}" \
            -D "logs-${{ inputs.source-github-run-id }}"
      - name: Upload logs to MySQL database
        env:
          ROCM_JAX_DB_HOSTNAME: ${{ secrets.ROCM_JAX_DB_HOSTNAME }}
          ROCM_JAX_DB_USERNAME: ${{ secrets.ROCM_JAX_DB_USERNAME }}
          ROCM_JAX_DB_PASSWORD: ${{ secrets.ROCM_JAX_DB_PASSWORD }}
          ROCM_JAX_DB_NAME: ${{ secrets.ROCM_JAX_DB_NAME }}
          ROCM_VERSION: ${{ inputs.rocm-version }}
          UBUNTU_VERSION: ${{ inputs.ubuntu-version }}
          LOGS_DIR: logs-${{ inputs.source-github-run-id }}
          GITHUB_SHA: ${{ inputs.github-sha }}
          GITHUB_RUN_ID: ${{ inputs.github-run-id }}
          ROCM_BUILD_NUM: ${{ inputs.rocm-build-num }}
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install mysql-connector-python

          python ci/upload_test_to_db.py \
          --logs_dir "$LOGS_DIR" \
          --run-tag "ci-run" \
          --runner-label "MI300" \
          --ubuntu-version "${UBUNTU_VERSION}" \
          --rocm-version "${ROCM_VERSION//.}" \
          --commit-sha "$GITHUB_SHA" \
          --build-num "$ROCM_BUILD_NUM" \
          --github-run-id "$GITHUB_RUN_ID"
