#!/usr/bin/env python3

# Copyright 2024 The JAX Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


# NOTE(mrodden): This file is part of the ROCm build scripts, and
# needs be compatible with Python 3.6. Please do not include these
# in any "upgrade" scripts


import argparse
import os
import subprocess
import sys


def dist_wheels(
    rocm_version,
    python_versions,
    xla_path,
    jax_path,
    rocm_build_job,
    rocm_build_num,
    therock_path,
    rbe,
    compiler,
    builder_image,
):
    if xla_path:
        xla_path = os.path.abspath(xla_path)

    # Use the manylinux image to build JAX/jaxlib wheels
    os.makedirs("wheelhouse", exist_ok=True)
    pyver_string = ",".join(python_versions)
    container_xla_path = "/xla"
    container_jax_path = "/jax"
    container_plugin_path = "/jax_rocm_plugin"

    # Build wheels via plugin's build_wheels.py (plugin + PJRT, optionally jaxlib).
    bw_cmd = [
        "python3",
        "/jax_rocm_plugin/build/rocm/tools/build_wheels.py",
        "--rocm-version",
        rocm_version,
        "--python-versions",
        pyver_string,
        "--compiler",
        compiler,
    ]

    if xla_path:
        bw_cmd.extend(["--xla-path", container_xla_path])

    if jax_path:
        bw_cmd.extend(["--jax-path", container_jax_path])

    if rbe:
        bw_cmd.append("--rbe")

    bw_cmd.append(container_plugin_path)
    bw_cmd.append("/jax")
    container_cmd = " ".join(bw_cmd)

    cmd = ["docker", "run"]
    mounts = [
        "-v",
        os.path.abspath("../") + ":/repo",
        "-v",
        os.path.abspath("./") + ":/jax_rocm_plugin",
        "-v",
        os.path.abspath("./wheelhouse") + ":/wheelhouse",
    ]

    if xla_path:
        mounts.extend(["-v", "%s:%s" % (xla_path, container_xla_path)])

    if jax_path:
        mounts.extend(["-v", "%s:%s" % (jax_path, container_jax_path)])

    cmd.extend(mounts)

    if os.isatty(sys.stdout.fileno()):
        cmd.append("-it")

    # NOTE(mrodden): bazel times out without --init, probably blocking on a zombie PID
    # NOTE: GIT_DIR and GIT_WORK_TREE are intentionally NOT set here because they
    # interfere with Bazel's git_repository rule when cloning external dependencies.
    cmd.extend(
        [
            "--init",
            "--rm",
            "--shm-size",
            "64G",
            "-e",
            "ROCM_VERSION_EXTRA=" + rocm_version,
            builder_image,
            "bash",
            "-c",
            container_cmd,
        ]
    )

    _ = subprocess.run(cmd, check=True)


def test(image_name):
    """Run unit tests like CI would inside a JAX image."""

    gpu_args = [
        "--device=/dev/kfd",
        "--device=/dev/dri",
        "--group-add",
        "video",
        "--cap-add=SYS_PTRACE",
        "--security-opt",
        "seccomp=unconfined",
        "--shm-size",
        "16G",
        "--env-file",
        "/etc/podinfo/gha-gpu-isolation-settings",
    ]

    cmd = [
        "docker",
        "run",
        "-it",
        "--rm",
    ]

    # NOTE(mrodden): we need jax source dir for the unit test code only,
    # JAX and jaxlib are already installed from wheels
    mounts = [
        "-v",
        os.path.abspath("./") + ":/jax",
    ]

    cmd.extend(mounts)
    cmd.extend(gpu_args)

    container_cmd = "cd /jax && ./build/rocm/build_rocm.sh && ./build/rocm/run_single_gpu.py -c && ./build/rocm/run_multi_gpu.sh"
    cmd.append(image_name)
    cmd.extend(
        [
            "bash",
            "-c",
            container_cmd,
        ]
    )

    subprocess.check_call(cmd)


def parse_args():
    p = argparse.ArgumentParser()

    p.add_argument(
        "--python-versions",
        type=lambda x: x.split(","),
        default="3.12",
        help="Comma separated list of CPython versions to build wheels for",
    )

    p.add_argument(
        "--rocm-version",
        help="ROCm version used for building wheels, testing, and installing into Docker image",
    )

    p.add_argument(
        "--xla-source-dir",
        help="Path to XLA source to use during plugin and jaxlib build, instead of builtin XLA",
    )

    p.add_argument(
        "--jax-source-dir",
        help="Optional JAX source directory. When provided, builds jaxlib wheel and copies to wheelhouse.",
    )

    p.add_argument(
        "--rbe",
        action="store_true",
        help="Enable Bazel RBE builds for JAX",
    )

    p.add_argument(
        "--compiler",
        choices=["gcc", "clang"],
        help="Compiler backend to use when compiling jax/jaxlib",
    )

    p.add_argument(
        "--builder-image",
        default=None,
    )

    subp = p.add_subparsers(dest="action", required=True)

    dwp = subp.add_parser("dist_wheels")

    testp = subp.add_parser("test")
    testp.add_argument("image_name")

    return p.parse_args()


def main():
    args = parse_args()

    if args.action == "dist_wheels":
        dist_wheels(
            args.rocm_version,
            args.python_versions,
            args.xla_source_dir,
            args.jax_source_dir,
            args.rocm_build_job,
            args.rocm_build_num,
            args.therock_path,
            args.rbe,
            args.compiler,
            args.builder_image,
        )

    elif args.action == "test":
        test(args.image_name)


if __name__ == "__main__":
    main()
