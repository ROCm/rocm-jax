FROM ubuntu:24.04

# Install python3 packages and solution for breaking system package 
RUN --mount=type=cache,target=/var/cache/apt \
    apt-get update && apt-get install -y python3 python-is-python3 python3-pip && \
    mv /usr/lib/python3.12/EXTERNALLY-MANAGED /usr/lib/python3.12/EXTERNALLY-MANAGED.old

# Install bzip2 and sqlite3 packages
RUN apt-get update && apt-get install -y \
    sqlite3 libsqlite3-dev \
    libbz2-dev \
    && rm -rf /var/lib/apt/lists/*

# Add target file to help determine which device(s) to build for
ARG GPU_DEVICE_TARGETS="gfx906 gfx908 gfx90a gfx942 gfx950 gfx1030 gfx1100 gfx1101 gfx1200 gfx1201"
ENV GPU_DEVICE_TARGETS=${GPU_DEVICE_TARGETS}

# Install ROCM
ARG ROCM_VERSION=6.2.0
ARG ROCM_PATH=/opt/rocm-${ROCM_VERSION}
ENV ROCM_PATH=${ROCM_PATH}
ARG ROCM_BUILD_JOB
ARG ROCM_BUILD_NUM
ARG THEROCK_PATH
RUN --mount=type=bind,source=jax_rocm_plugin/build/rocm/tools/get_rocm.py,target=get_rocm.py \
    --mount=type=cache,target=/var/cache/apt \
    --mount=type=bind,from=therock,target=/tmp/therock/ \
    python3 get_rocm.py --rocm-version=$ROCM_VERSION --job-name=$ROCM_BUILD_JOB --build-num=$ROCM_BUILD_NUM --therock-path=$THEROCK_PATH
ENV PATH="$PATH:/opt/rocm/bin:/opt/rocm/llvm/bin"
ENV ln -s "/opt/rocm-${ROCM_RELEASE}/lib/librocblas.so.5" "/opt/rocm-${ROCM_RELEASE}/lib/librocblas.so.4"
ENV LD_LIBRARY_PATH="/opt/rocm-${ROCM_VERSION}/lib:$LD_LIBRARY_PATH"
ENV LLVM_PATH="/opt/rocm-${ROCM_VERSION}/llvm"

# Set up paths
ENV HCC_HOME=$ROCM_PATH/hcc
ENV HIP_PATH=$ROCM_PATH/
ENV OPENCL_ROOT=$ROCM_PATH/opencl
ENV PATH="$HCC_HOME/bin:$HIP_PATH/bin:${PATH}"
ENV PATH="$ROCM_PATH/bin:${PATH}"
ENV PATH="$OPENCL_ROOT/bin:${PATH}"
ENV PATH="/root/bin:/root/.local/bin:$PATH"

RUN --mount=type=cache,mode=0755,target=/root/.cache/pip \
    pip3 install --break-system-packages \
        "numpy<2" \
        build \
        wheel \
        six \
        auditwheel \
        scipy \
        pytest \
        pytest-html \
        pytest_html_merger \
        pytest-reportlog \
        pytest-rerunfailures \
        pytest-json-report \
        cloudpickle \
        portpicker \
        matplotlib \
        absl-py \
        flatbuffers \
        hypothesis

# install jax and jaxlib from requirements file
RUN --mount=type=cache,mode=0755,target=/root/.cache/pip \
    --mount=type=bind,source=build/requirements.txt,target=requirements.txt \
    pip3 install --break-system-packages -r requirements.txt

# namespace patch (this patch is needed for ROCM_VERSION >= 7)
COPY jax_rocm_plugin/third_party/jax/namespace.patch /tmp/namespace.patch

RUN bash -c '  \
    major_version=$(echo "$ROCM_VERSION" | cut -d. -f1) && \
    if [ "$major_version" -ge 7 ]; then \
        echo "Applying patch for ROCm $ROCM_VERSION..."; \
        dist_packages=$(python3 -c "import sysconfig; print(sysconfig.get_paths()[\"purelib\"])") && \
        patch -p1 -d "$dist_packages" < /tmp/namespace.patch; \
    else \
        echo "ROCm version $ROCM_VERSION, skipping patch."; \
    fi'

# Build metadata (wired from your Python build args)
ARG PYTHON_VERSION=3.10
ARG BUILD_DATE=""
ARG BUILD_TIMESTAMP=""

# rocm/jax
ARG ROCM_JAX_COMMIT="unknown"
ARG ROCM_JAX_COMMIT_TITLE="unknown"
ARG ROCM_JAX_COMMIT_DATE="unknown"
# rocm/xla
ARG ROCM_XLA_COMMIT="unknown"
ARG ROCM_XLA_COMMIT_TITLE="unknown"
ARG ROCM_XLA_COMMIT_DATE="unknown"
# rocm/rocm-jax (plugin)
ARG ROCM_ROCM_JAX_COMMIT="unknown"
ARG ROCM_ROCM_JAX_COMMIT_TITLE="unknown"
ARG ROCM_ROCM_JAX_COMMIT_DATE="unknown"

# Legacy (optional; keep if other tooling reads these)
ARG JAX_VERSION=""
ARG JAX_COMMIT=""
ARG XLA_COMMIT=""

# Labels that match your Python inspector
LABEL \
  com.amdgpu.build_date="${BUILD_DATE}" \
  com.amdgpu.build_timestamp="${BUILD_TIMESTAMP}" \
  com.amdgpu.rocm_version="${ROCM_VERSION}" \
  com.amdgpu.python_version="${PYTHON_VERSION}" \
  com.amdgpu.jax_version="${JAX_VERSION}" \
  com.amdgpu.rocm_jax.commit="${ROCM_JAX_COMMIT}" \
  com.amdgpu.rocm_jax.commit_title="${ROCM_JAX_COMMIT_TITLE}" \
  com.amdgpu.rocm_jax.commit_date="${ROCM_JAX_COMMIT_DATE}" \
  com.amdgpu.rocm_xla.commit="${ROCM_XLA_COMMIT}" \
  com.amdgpu.rocm_xla.commit_title="${ROCM_XLA_COMMIT_TITLE}" \
  com.amdgpu.rocm_xla.commit_date="${ROCM_XLA_COMMIT_DATE}" \
  com.amdgpu.rocm_rocm_jax.commit="${ROCM_ROCM_JAX_COMMIT}" \
  com.amdgpu.rocm_rocm_jax.commit_title="${ROCM_ROCM_JAX_COMMIT_TITLE}" \
  com.amdgpu.rocm_rocm_jax.commit_date="${ROCM_ROCM_JAX_COMMIT_DATE}"

RUN --mount=type=cache,mode=0755,target=/root/.cache/pip \
    --mount=type=bind,source=wheelhouse,target=/wheelhouse \
    ls -lah /wheelhouse && \
    pip3 install --break-system-packages -f /wheelhouse --no-deps --no-index jax_rocm7_plugin jax_rocm7_pjrt
